name: Auto Tag Release

on:
  push:
    branches:
      - master
jobs:
  auto-tag-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Extract commit message
        run: echo ::set-output name=message::$(git log --format=%B -n 1 ${{ github.sha }})
      - name: Check commit message pattern
        run: |
          if [[ "${{ steps.extract_commit_message.outputs.message }}" =~ ^(\[(v?[0-9]+\.[0-9]+\.[0-9]+)\]:\s|\[([0-9]+\.[0-9]+\.[0-9]+)\]:\s) ]]; then
            echo "::set-output name=version::${BASH_REMATCH[1]}"
            echo "::set-output name=is_matching::true"
          else
            echo "::set-output name=is_matching::false"
          fi
      - name: Create tag
        uses: anothrNick/github-tag-action@1.30.0
        if: steps.check_commit_message.outputs.is_matching == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          release_branch: ${{ github.ref#refs/heads/ }}
          tag_name: ${{ steps.check_commit_message.outputs.version }}
          tag_message: ${{ steps.extract_commit_message.outputs.message }}
